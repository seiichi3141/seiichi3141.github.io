<!DOCTYPE html>
<html><head>
  <meta lang="ja">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="seiichi3141" />
  <meta name="description" content="プログラミングやFlutter関連の情報" />
  <meta name="keywords" content="プログラミング,Flutter,Dart">
  <title>Flutterとstate_notifierとfreezedで作るTodoアプリ | 健康優良不良プログラマ</title>
  
  
  <link rel="stylesheet" href="https://blog.seiichirou.jp/sass/main.css" />
  <link href="http://fonts.googleapis.com/earlyaccess/notosansjp.css">
  <link href="https://use.fontawesome.com/releases/v5.9.0/css/all.css" rel="stylesheet">
  <link href="https://blog.seiichirou.jp/css/syntax.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@300;400;500;700&display=swap" rel="stylesheet">
  <meta name="google-site-verification" content="hSHRu1AofaNfP4SrnmMHbbG0VYL9D17LOFaRnoUxCjc" />
  
    
    
<script async src="https://www.googletagmanager.com/gtag/js?id=G-RP80Q2EE1S"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-RP80Q2EE1S');
</script>
    
  
</head><body><header class="bg-dark">
  <div class="container">
    <nav class="navbar navbar-expand-lg navbar-dark pr-0 pl-0">
      <a class="navbar-brand font-weight-bold" href="/">
        <i class="fas fa-blog text-light d-inline-block align-top lead mr-3"></i>健康優良不良プログラマ
      </a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item">
            <a class="nav-link" href="/portfolio">ポートフォリオ</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/apps/aozora">Yom!青空文庫</a>
          </li>
          <li class="nav-item">
            <a class="nav-link" href="/apps/cube_lbl_memo">CFOP</a>
          </li>
        </ul>
      </div>
      <div>
        <a href="https://github.com/seiichi3141"><i class="fab fa-lg fa-github text-light mr-2"></i></a>
        <a href="https://www.facebook.com/seiichirou.tanaka"><i class="fab fa-lg fa-facebook text-light mr-2"></i></a>
        <a href="https://twitter.com/seiichi3141"><i class="fab fa-lg fa-twitter text-light mr-2"></i></a>
        <a href="https://www.instagram.com/seiichi3141"><i class="fab fa-lg fa-instagram text-light"></i></a>
      </div>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </nav>
  </div>
</header><main role="main">
    <div class="container">
<article class="row">
  <div class="pt-5 col-md-9">
    <header>
      <div class="row">
        
        
        <div class="col-12 col-sm-4">
          
          <img class="img-fluid img-thumbnail" src="https://blog.seiichirou.jp/img/flutter_logo.png" alt="">
        </div>
        <div class="col-12 col-sm-8 mt-3 mt-sm-0">
          
          <p class="small mb-1">
            <i class="fas fa-folder mr-1 text-muted"></i>
            
            
            <a class="text-muted" href="https://blog.seiichirou.jp/categories/flutter/">Flutter</a>
            
            
          </p>
          
          <h1 class="font-weight-bold">Flutterとstate_notifierとfreezedで作るTodoアプリ</h1>
          
          <p class="small mb-1">
            <i class="fas fa-tag text-muted mr-1"></i>
            
            
            <a class="text-muted" href="https://blog.seiichirou.jp/tags/flutter/"><span class="badge badge-secondary align-middle">Flutter</span></a>
            
            
            
            <a class="text-muted" href="https://blog.seiichirou.jp/tags/state_notifier/"><span class="badge badge-secondary align-middle">state_notifier</span></a>
            
            
            
            <a class="text-muted" href="https://blog.seiichirou.jp/tags/freezed/"><span class="badge badge-secondary align-middle">freezed</span></a>
            
            
          </p>
          
        </div>
        
      </div>
    </header>
    <section class="content"><p>今まではflutter_blocを使っていたんですが、state_notifierとfreezedのコンボでだいぶ記述量が減ると知って試してからすっかり気に入って、開発中のアプリもほとんど書き換えてしまいました。</p>
<p>今回はそのstate_notifierとfreezedで簡単なTodoリストアプリを作ってその便利さ紹介できたらいいなと思っています。</p>
<p>リポジトリは<a href="https://github.com/seiichi3141/state_notifier_todo">こちら</a>です。</p>
<h2 id="概要">概要</h2>
<ul>
<li>ModelやStateにfreezedを使って手軽にimmutableやcopyWithを実現する</li>
<li>StateNotifierを継承したControllerを実装してstateを管理する</li>
<li>ScreenはStateを監視して表示、Controllerを介してstate操作を行う</li>
<li>ProviderでStateやControllerの受け渡しを簡潔にする</li>
</ul>
<h2 id="todoリストの機能">Todoリストの機能</h2>
<ul>
<li>Todoを追加できる</li>
<li>Todoの未完了-完了を切り替えられる</li>
<li>リスト表示画面では未完了のリスト、完了のリストの表示を切り替えることができる</li>
</ul>
<h2 id="使用するライブラリ">使用するライブラリ</h2>
<table>
<thead>
<tr>
<th>Package</th>
<th></th>
</tr>
</thead>
<tbody>
<tr>
<td>flutter_state_notofier</td>
<td>StateNotifierやStateNotifierProviderを使うため</td>
</tr>
<tr>
<td>freezed_annotation</td>
<td>freezedでコード生成するためのアノテーション</td>
</tr>
<tr>
<td>provider</td>
<td>Providerへのアクセスを容易にするため</td>
</tr>
<tr>
<td>uuid</td>
<td>TodoアイテムへのID付け</td>
</tr>
</tbody>
</table>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-yaml" data-lang="yaml"><span class="line"><span class="cl"><span class="nt">dependencies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flutter</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sdk</span><span class="p">:</span><span class="w"> </span><span class="l">flutter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">cupertino_icons</span><span class="p">:</span><span class="w"> </span><span class="l">^0.1.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flutter_state_notifier</span><span class="p">:</span><span class="w"> </span><span class="l">^0.4.2</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">freezed_annotation</span><span class="p">:</span><span class="w"> </span><span class="l">^0.7.1</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">provider</span><span class="p">:</span><span class="w"> </span><span class="l">^4.1.3</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">uuid</span><span class="p">:</span><span class="w"> </span><span class="l">^2.0.4</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="nt">dev_dependencies</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">flutter_test</span><span class="p">:</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">    </span><span class="nt">sdk</span><span class="p">:</span><span class="w"> </span><span class="l">flutter</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">freezed</span><span class="p">:</span><span class="w"> </span><span class="l">^0.10.9</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w">  </span><span class="nt">build_runner</span><span class="p">:</span><span class="w"> </span><span class="l">^1.10.0</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><h2 id="モデル">モデル</h2>
<h3 id="todo">Todo</h3>
<p>Todoを表すModelを実装します。freezedアノテーションをつけ、コンストラクタやcopyWithなどを自動生成するようにします。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="k">import</span> <span class="s1">&#39;package:flutter/foundation.dart&#39;</span><span class="p">;</span> <span class="c1">// *.freezed.dartで必要なのでimportしておく
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="k">import</span> <span class="s1">&#39;package:freezed_annotation/freezed_annotation.dart&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="k">part</span> <span class="s1">&#39;todo.freezed.dart&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">freezed</span>
</span></span><span class="line"><span class="cl"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">Todo</span> <span class="kd">with</span> <span class="n">_$Todo</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="kd">factory</span> <span class="n">Todo</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="kt">String</span> <span class="n">id</span><span class="p">,</span>  <span class="c1">// uuidで割りつける予定
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="kt">String</span> <span class="n">title</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="err">@</span><span class="n">Default</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span> <span class="kt">bool</span> <span class="n">completed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span> <span class="o">=</span> <span class="n">TodoData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="ステートとコントローラ">ステートとコントローラ</h2>
<h3 id="todosstate">TodosState</h3>
<p>TodosStateを実装します。freezedアノテーションをつけ、データを持つTodoStateDataとローディング中を示すTodosStateLoadingの二つの状態を定義します。</p>
<p>TodosStateのクラスをチェックし、TodosStateLoadingであればまだ読み込み中、TodosStateDataであればデータの読み込みが終わったという判断ができるようになります。</p>
<p>TodosStateDataにはすべてのTodoが入るtodosを持っててもらいます。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="k">part</span> <span class="s1">&#39;todos_state.freezed.dart&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">freezed</span>
</span></span><span class="line"><span class="cl"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">TodosState</span> <span class="kd">with</span> <span class="n">_$TodosState</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="kd">factory</span> <span class="n">TodosState</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="err">@</span><span class="n">Default</span><span class="p">(</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">[])</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span> <span class="o">=</span> <span class="n">TodosStateData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="kd">factory</span> <span class="n">TodosState</span><span class="p">.</span><span class="n">loading</span><span class="p">()</span> <span class="o">=</span> <span class="n">TodosStateLoading</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="todoscontoller">TodosContoller</h3>
<p>このTodosStateへの操作はStateNotifierを継承したTodosControllerを通してやります。TodosControllerはLocatorMixinを宣言しておきcontextにあるproviderへのアクセスを容易にしておきます。
ここでは仮にinitStateで5秒間ウエイトを入れ、その後初期データとしていくつかのTodoをstateへ設定しています。
本番ではここでRepositoryなりDBなりからロードすることになるはずです。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">TodosController</span> <span class="kd">extends</span> <span class="n">StateNotifier</span><span class="o">&lt;</span><span class="n">TodosState</span><span class="o">&gt;</span> <span class="kd">with</span> <span class="n">LocatorMixin</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">TodosController</span><span class="p">()</span> <span class="o">:</span> <span class="k">super</span><span class="p">(</span><span class="kd">const</span> <span class="n">TodosState</span><span class="p">.</span><span class="n">loading</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">_uuid</span> <span class="o">=</span> <span class="n">Uuid</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">initState</span><span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">initState</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="kd">await</span> <span class="n">Future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span><span class="p">.</span><span class="n">delayed</span><span class="p">(</span><span class="kd">const</span> <span class="n">Duration</span><span class="p">(</span><span class="nl">seconds:</span> <span class="m">3</span><span class="p">));</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// 初期データを設定、TodosStateLoadingからTodoStateDataへ変わるのでローディング完了の状態となる
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">state</span> <span class="o">=</span> <span class="n">TodosState</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">todos:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">Todo</span><span class="p">(</span><span class="nl">id:</span> <span class="n">_uuid</span><span class="p">.</span><span class="n">v4</span><span class="p">(),</span> <span class="nl">title:</span> <span class="s1">&#39;朝食を食べる&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">Todo</span><span class="p">(</span><span class="nl">id:</span> <span class="n">_uuid</span><span class="p">.</span><span class="n">v4</span><span class="p">(),</span> <span class="nl">title:</span> <span class="s1">&#39;ラジオ体操をやる&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="n">Todo</span><span class="p">(</span><span class="nl">id:</span> <span class="n">_uuid</span><span class="p">.</span><span class="n">v4</span><span class="p">(),</span> <span class="nl">title:</span> <span class="s1">&#39;薬を飲む&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>また、TodosControllerではadd/toggleを外部に公開し、todoの追加、未完了/完了切り替えをできるようにします。</p>
<p>stateはimmutableなのでメンバ変数を直接変更することはできません。なので、stateを更新するときは現在のstateからcopyWithでコピーするか、新規のstateで上書きすることになります。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">add</span><span class="p">(</span><span class="kt">String</span> <span class="n">title</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">currentState</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span> <span class="k">is</span> <span class="n">TodosStateData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// todosのクローンに新しいTodoを追加してstateを更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">final</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">currentState</span><span class="p">.</span><span class="n">todos</span><span class="p">.</span><span class="n">toList</span><span class="p">()</span>
</span></span><span class="line"><span class="cl">        <span class="p">..</span><span class="n">add</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="n">Todo</span><span class="p">(</span><span class="nl">id:</span> <span class="n">_uuid</span><span class="p">.</span><span class="n">v4</span><span class="p">(),</span> <span class="nl">title:</span> <span class="n">title</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span> <span class="o">=</span> <span class="n">currentState</span><span class="p">.</span><span class="n">copyWith</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">todos:</span> <span class="n">todos</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">toggle</span><span class="p">(</span><span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">currentState</span> <span class="o">=</span> <span class="n">state</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="k">if</span> <span class="p">(</span><span class="n">currentState</span> <span class="k">is</span> <span class="n">TodosStateData</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// Todoを検索してcomplatedをtoggleし、stateを更新
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="kd">final</span> <span class="n">clone</span> <span class="o">=</span> <span class="n">currentState</span><span class="p">.</span><span class="n">todos</span><span class="p">.</span><span class="n">map</span><span class="p">((</span><span class="n">t</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="p">(</span><span class="n">t</span> <span class="o">==</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">          <span class="k">return</span> <span class="n">t</span><span class="p">.</span><span class="n">copyWith</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nl">completed:</span> <span class="o">!</span><span class="n">t</span><span class="p">.</span><span class="n">completed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">t</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">      <span class="p">}).</span><span class="n">toList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span> <span class="o">=</span> <span class="n">TodosState</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">todos:</span> <span class="n">clone</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">}</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="filteredtodosstate">FilteredTodosState</h3>
<p>TodosStateをそのまま表示に使うこともできますが、今回はフィルタリングしたリストを表示したいと考えています。そのために画面の表示用にTodoのリストをフィルタリングした結果を持つFilteredTodosStateを実装をします。</p>
<p>現在のフィルタリングのパラメータとしてcompleted変数を、フィルタリングされたTodoのリストとしてtodos持っててもらいます。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="k">part</span> <span class="s1">&#39;filtered_todos_state.freezed.dart&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="err">@</span><span class="n">freezed</span>
</span></span><span class="line"><span class="cl"><span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">FilteredTodosState</span> <span class="kd">with</span> <span class="n">_$FilteredTodosState</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">const</span> <span class="kd">factory</span> <span class="n">FilteredTodosState</span><span class="p">({</span>
</span></span><span class="line"><span class="cl">    <span class="err">@</span><span class="n">Default</span><span class="p">(</span><span class="kc">false</span><span class="p">)</span> <span class="kt">bool</span> <span class="n">completed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">    <span class="err">@</span><span class="n">Default</span><span class="p">(</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span><span class="p">[])</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">  <span class="p">})</span> <span class="o">=</span> <span class="n">FilteredTodosStateData</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="filteredtodoscontroller">FilteredTodosController</h3>
<p>FilteredTodosControllerを実装します。フィルタのパラメータ変更機能を提供します。</p>
<p>LocatorMixinを宣言するとBuildContextからStateやControllerを探してきてくれるread関数やwatch関数を使えるようになります。update関数をoverrideして使えるようにもなります。ここでwatchしたStateやControllerは、その変化を検出できるようになります。</p>
<p>ここではTodosStateをwatchしtodosが更新されるたびにfilteredTodos関数を実行して最新の情報へアップデートするようにしました。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">FilteredTodosController</span> <span class="kd">extends</span> <span class="n">StateNotifier</span><span class="o">&lt;</span><span class="n">FilteredTodosState</span><span class="o">&gt;</span>
</span></span><span class="line"><span class="cl">    <span class="kd">with</span> <span class="n">LocatorMixin</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="n">FilteredTodosController</span><span class="p">()</span> <span class="o">:</span> <span class="k">super</span><span class="p">(</span><span class="kd">const</span> <span class="n">FilteredTodosState</span><span class="p">());</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">update</span><span class="p">(</span><span class="n">Locator</span> <span class="n">watch</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">super</span><span class="p">.</span><span class="n">update</span><span class="p">(</span><span class="n">watch</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">    <span class="c1">// TodosStateを監視、stateがTodosStateDataなら更新されたtodosが渡されてくる、そのほかのstateは無視する
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>    <span class="n">watch</span><span class="o">&lt;</span><span class="n">TodosState</span><span class="o">&gt;</span><span class="p">().</span><span class="n">maybeWhen</span><span class="p">((</span><span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">copyWith</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">completed:</span> <span class="n">state</span><span class="p">.</span><span class="n">completed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">todos:</span> <span class="n">_filteredTodos</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="nl">completed:</span> <span class="n">state</span><span class="p">.</span><span class="n">completed</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="nl">orElse:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">_filteredTodos</span><span class="p">(</span><span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;</span> <span class="n">todos</span><span class="p">,</span> <span class="p">{</span><span class="kt">bool</span> <span class="n">completed</span><span class="p">})</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">todos</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">where</span><span class="p">((</span><span class="n">todo</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">completed</span> <span class="o">?</span> <span class="n">todo</span><span class="p">.</span><span class="n">completed</span> <span class="o">:</span> <span class="o">!</span><span class="n">todo</span><span class="p">.</span><span class="n">completed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">        <span class="p">.</span><span class="n">toList</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>toggle関数でstateのcompletedを変更し、Todoのリストもそれに合わせてアップデートします。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl">  <span class="kt">void</span> <span class="n">toggle</span><span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="kd">final</span> <span class="n">completed</span> <span class="o">=</span> <span class="o">!</span><span class="n">state</span><span class="p">.</span><span class="n">completed</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">    <span class="n">read</span><span class="o">&lt;</span><span class="n">TodosState</span><span class="o">&gt;</span><span class="p">().</span><span class="n">maybeWhen</span><span class="p">((</span><span class="n">todos</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">      <span class="n">state</span> <span class="o">=</span> <span class="n">state</span><span class="p">.</span><span class="n">copyWith</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">completed:</span> <span class="n">completed</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">todos:</span> <span class="n">_filteredTodos</span><span class="p">(</span><span class="n">todos</span><span class="p">,</span> <span class="nl">completed:</span> <span class="n">completed</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">);</span>
</span></span><span class="line"><span class="cl">    <span class="p">},</span> <span class="nl">orElse:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="kc">null</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="freezeddartの生成">*.freezed.dartの生成</h3>
<p>build_runnerを動作させて、freezedアノテーションを付けたclassを実装する*.freezed.dartファイルを生成します。</p>
<pre tabindex="0"><code>flutter pub pub run build_runner build
</code></pre><h2 id="スクリーン">スクリーン</h2>
<h3 id="filteredtodos">FilteredTodos</h3>
<p>フィルタリングされたTodoのリストを表示するためのWidgetを実装します。</p>
<p>providerパッケージの機能であるcontext.watchを使って、TodosStateの監視を行います。freezedの機能のwhen関数で現在のstateによって返すWidgetを変えることができます。</p>
<p>loadingの場合はCircularProgressIndicatorを返してローディング中だとわかるようにします。</p>
<p>Dataのstateだった場合はローディングが終わっています。context.selectを使ってFilteredTodosStateのtodosを監視し、その内容でListViewを構築して返します。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">FilteredTodos</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">context</span><span class="p">.</span><span class="n">watch</span><span class="o">&lt;</span><span class="n">TodosState</span><span class="o">&gt;</span><span class="p">().</span><span class="n">when</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// TodosStateDataの場合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="kd">final</span> <span class="n">todos</span> <span class="o">=</span> <span class="n">context</span>
</span></span><span class="line"><span class="cl">            <span class="p">.</span><span class="n">select</span><span class="o">&lt;</span><span class="n">FilteredTodosState</span><span class="p">,</span> <span class="n">List</span><span class="o">&lt;</span><span class="n">Todo</span><span class="o">&gt;&gt;</span><span class="p">((</span><span class="n">state</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">state</span><span class="p">.</span><span class="n">todos</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">        <span class="k">return</span> <span class="n">ListView</span><span class="p">.</span><span class="n">builder</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">padding:</span> <span class="kd">const</span> <span class="n">EdgeInsets</span><span class="p">.</span><span class="n">all</span><span class="p">(</span><span class="m">16</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="nl">itemCount:</span> <span class="n">todos</span><span class="p">.</span><span class="n">length</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="nl">itemBuilder:</span> <span class="p">(</span><span class="n">_</span><span class="p">,</span> <span class="n">index</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="kd">final</span> <span class="n">todo</span> <span class="o">=</span> <span class="n">todos</span><span class="p">[</span><span class="n">index</span><span class="p">];</span>
</span></span><span class="line"><span class="cl">            <span class="k">return</span> <span class="n">_buildCard</span><span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">todo</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">);</span>
</span></span><span class="line"><span class="cl">      <span class="p">},</span>
</span></span><span class="line"><span class="cl">      <span class="c1">// TodosStateLoadingの場合
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>      <span class="nl">loading:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="kd">const</span> <span class="n">Center</span><span class="p">(</span><span class="nl">child:</span> <span class="n">CircularProgressIndicator</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ListViewのアイテムとして使うListTileには完了したかどうかを示すアイコンを表示します。今回はTodoのcompletedによって色を切り替えています。</p>
<p>アイコンが押された時にはcontext.readでTodosControllerを見つけ出してtoggleを実行するようにしています。</p>
<p>これにより、</p>
<p>toggleが実行される-&gt;TodosStateが更新される-&gt;FilteredTodosControllerがそれを検知しstateを更新する-&gt;FilteredTodos Widgetがそれを検知し表示を更新する</p>
<p>といった流れでTodosStateの変化に合わせてリストに表示されるTodoが更新されるようになります。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">_buildCard</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">,</span> <span class="n">Todo</span> <span class="n">todo</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Card</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">ListTile</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">title:</span> <span class="n">Text</span><span class="p">(</span><span class="n">todo</span><span class="p">.</span><span class="n">title</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="nl">trailing:</span> <span class="n">IconButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">icon:</span> <span class="n">Icon</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="n">Icons</span><span class="p">.</span><span class="n">done</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">            <span class="nl">color:</span> <span class="n">todo</span><span class="p">.</span><span class="n">completed</span> <span class="o">?</span> <span class="n">Colors</span><span class="p">.</span><span class="n">green</span> <span class="o">:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">grey</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="nl">onPressed:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">context</span><span class="p">.</span><span class="n">read</span><span class="o">&lt;</span><span class="n">TodosController</span><span class="o">&gt;</span><span class="p">().</span><span class="n">toggle</span><span class="p">(</span><span class="n">todo</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="filteredtodosscreen">FilteredTodosScreen</h3>
<p>先ほど実装したFilteredTodos Widgetの表示や、未完了/完了の切り替え、新しいTodoの追加を行うための画面、FilteredTodosScreenを実装します。</p>
<p>AppBarとFilteredTodosを構築している箇所です。</p>
<p>AppBarにはactionsにIcons.done_allを使ったIconButtonを追加して、未完了/完了のどちらを表示しているかを表しています。FilteredTodosStateのcompletedを監視してその色を決めています。</p>
<p>押された時にはFilteredTodosControllerのtoggleを実行させてリストを更新させます。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">FilteredTodosScreen</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="kd">final</span> <span class="n">_textEditingController</span> <span class="o">=</span> <span class="n">TextEditingController</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Scaffold</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">appBar:</span> <span class="n">_buildAppBar</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">body:</span> <span class="n">_buildBody</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">PreferredSizeWidget</span> <span class="n">_buildAppBar</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">AppBar</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">title:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;Todo&#39;</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">centerTitle:</span> <span class="kc">true</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">      <span class="nl">actions:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">IconButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">icon:</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">done_all</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nl">color:</span> <span class="n">context</span><span class="p">.</span><span class="n">select</span><span class="o">&lt;</span><span class="n">FilteredTodosState</span><span class="p">,</span> <span class="kt">bool</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                      <span class="p">(</span><span class="n">state</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">state</span><span class="p">.</span><span class="n">completed</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">                  <span class="o">?</span> <span class="n">Colors</span><span class="p">.</span><span class="n">white</span>
</span></span><span class="line"><span class="cl">                  <span class="o">:</span> <span class="n">Colors</span><span class="p">.</span><span class="n">grey</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="nl">onPressed:</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="n">context</span><span class="p">.</span><span class="n">read</span><span class="o">&lt;</span><span class="n">FilteredTodosController</span><span class="o">&gt;</span><span class="p">().</span><span class="n">toggle</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">          <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">_buildBody</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Column</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">children:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">        <span class="n">Expanded</span><span class="p">(</span><span class="nl">child:</span> <span class="n">FilteredTodos</span><span class="p">()),</span>
</span></span><span class="line"><span class="cl">        <span class="n">_buildPanel</span><span class="p">(</span><span class="n">context</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">],</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>新しいTodoを追加するためのTexitFieldとFloatingActionButtonを実装しているところです。</p>
<p>追加ボタンが押されたときに、TodosControllerのaddにTexitFieldの内容を渡して新しいTodoを追加させ、TextFieldの内容をクリアさせています。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">_buildPanel</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">Padding</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">padding:</span> <span class="kd">const</span> <span class="n">EdgeInsets</span><span class="p">.</span><span class="n">all</span><span class="p">(</span><span class="m">16</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">Row</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">children:</span> <span class="p">[</span>
</span></span><span class="line"><span class="cl">          <span class="n">Expanded</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nl">child:</span> <span class="n">TextField</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">              <span class="nl">controller:</span> <span class="n">_textEditingController</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="nl">decoration:</span> <span class="kd">const</span> <span class="n">InputDecoration</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">                <span class="nl">hintText:</span> <span class="s1">&#39;タイトル&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">                <span class="nl">filled:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">              <span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">          <span class="n">FloatingActionButton</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">            <span class="nl">child:</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">add</span><span class="p">),</span>
</span></span><span class="line"><span class="cl">            <span class="nl">onPressed:</span> <span class="p">()</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">              <span class="kd">var</span> <span class="n">title</span> <span class="o">=</span> <span class="n">_textEditingController</span><span class="p">.</span><span class="n">value</span><span class="p">.</span><span class="n">text</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="k">if</span> <span class="p">(</span><span class="n">title</span><span class="p">.</span><span class="n">isEmpty</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">                <span class="n">title</span> <span class="o">=</span> <span class="s1">&#39;No Title&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl">              <span class="p">}</span>
</span></span><span class="line"><span class="cl">              <span class="n">context</span><span class="p">.</span><span class="n">read</span><span class="o">&lt;</span><span class="n">TodosController</span><span class="o">&gt;</span><span class="p">().</span><span class="n">add</span><span class="p">(</span><span class="n">title</span><span class="p">);</span>
</span></span><span class="line"><span class="cl">              <span class="n">_textEditingController</span><span class="p">.</span><span class="n">clear</span><span class="p">();</span>
</span></span><span class="line"><span class="cl">            <span class="p">},</span>
</span></span><span class="line"><span class="cl">          <span class="p">),</span>
</span></span><span class="line"><span class="cl">        <span class="p">],</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="プロバイダー">プロバイダー</h2>
<h3 id="maindart">main.dart</h3>
<p>このままMaterialAppにFilterdTodosScreenを渡して表示させようとするとcontextにStateやControllerが見当たらないと怒られてしまいます。</p>
<p>まず、App全体で利用するだろうTodosState/TodosControllerはMaterialAppをStateNotifierProviderでWrapして使えるようします。</p>
<p>また、FilteredTodosState/FilteredTodosControllerはそれを利用するFilteredTodosScreenをStateNotifierProviderでWrapして使えるようにしておきます。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-dart" data-lang="dart"><span class="line"><span class="cl"><span class="kd">class</span> <span class="nc">App</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">  <span class="err">@</span><span class="n">override</span>
</span></span><span class="line"><span class="cl">  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="k">return</span> <span class="n">StateNotifierProvider</span><span class="o">&lt;</span><span class="n">TodosController</span><span class="p">,</span> <span class="n">TodosState</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">      <span class="nl">create:</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">TodosController</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">      <span class="nl">child:</span> <span class="n">MaterialApp</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="nl">title:</span> <span class="s1">&#39;State Notifier Todo Demo&#39;</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">debugShowCheckedModeBanner:</span> <span class="kc">false</span><span class="p">,</span>
</span></span><span class="line"><span class="cl">        <span class="nl">home:</span>
</span></span><span class="line"><span class="cl">            <span class="n">StateNotifierProvider</span><span class="o">&lt;</span><span class="n">FilteredTodosController</span><span class="p">,</span> <span class="n">FilteredTodosState</span><span class="o">&gt;</span><span class="p">(</span>
</span></span><span class="line"><span class="cl">          <span class="nl">create:</span> <span class="p">(</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">FilteredTodosController</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">          <span class="nl">child:</span> <span class="n">FilteredTodosScreen</span><span class="p">(),</span>
</span></span><span class="line"><span class="cl">        <span class="p">),</span>
</span></span><span class="line"><span class="cl">      <span class="p">),</span>
</span></span><span class="line"><span class="cl">    <span class="p">);</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="実行">実行</h2>
<p>実装は以上です。動かしてみましょう。</p>
<p><img src="https://user-images.githubusercontent.com/1445649/84268675-fee84100-ab62-11ea-9fee-3f4db43b012c.gif" alt="state_notifier_todo"></p>
<p>ちょっとわかりにくいですがFuture.delayによるローディング、Todoの追加や未完了/完了のtoggle、フィルタもうまく動いているのがわかると思います。</p>
<h2 id="まとめ">まとめ</h2>
<p>state_notifierとfreezedを使ってTodoリストを実装することができました。</p>
<p>Todoのリストを管理しているおおもとはTodosState/TodosControllerです。FilteredTodosState/FilteredTodosControllerはその情報をもとに独自のパラメータを利用してリストを加工しているにすぎません。例えばこのアプリにTodo検索の機能を追加したいと考えたとき、SearchTodosState/SearchTodosControllerを追加して入力されたキーワードをもとにリストを加工してそのstateに持たせることができるでしょう。App以下であればTodosControllerを介してTodosStateを更新すれば、それを監視しているStateやScreenだけがその変化によって振る舞いを変えてくれます。</p>
<p>freezedのおかげでModelやStateの実装も楽にできました。freezedにはjson_serializationとの連携もありますので、DBの実装もかなり楽になると思います。</p>
<p>一度試してみてはいかがでしょうか。</p>
</section>
    <div class="border p-3">
      Flutterを使ったアプリをリリースしてます。良ければ使ってみてください。
      <div class="media mt-2">
        <a href="/apps/aozora">
          <div class="appicon-lg rounded mr-2">
            <img src="/apps/aozora/icon.png">
          </div>
        </a>
        <div class="appmedia media-body">
          <a href="/apps/aozora" class="text-dark"><h5 class="mt-0"><strong>Yom!青空文庫</strong></h5></a>
          <a target="_blank" href='https://apps.apple.com/jp/app/yom-%E9%9D%92%E7%A9%BA%E6%96%87%E5%BA%AB/id1530145482'>
            <img width="135px" height="40px" src='/img/badge-lrg.svg'/>
          </a>
          <a target="_blank" href='https://play.google.com/store/apps/details?id=jp.seiichirou.aozora'>
            <img alt='Google Play で手に入れよう' width="135px" height="40px" src='/img/ja_badge_web_generic.png'/>
          </a>
        </div>
      </div>
    </div><footer>
  <div class="container mb-5">
    <small>
      <ul class="nav justify-content-center">
        <li class="nav-item"><a class="nav-link text-muted" href="https://twitter.com/seiichi3141">seiichi3141@</a></li>
        
      </ul>
    </small>
  </div>
</footer></div>
  <div class="d-none d-md-block col-md-3 border-left border-right">
    <aside class="toc pt-5">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#概要">概要</a></li>
    <li><a href="#todoリストの機能">Todoリストの機能</a></li>
    <li><a href="#使用するライブラリ">使用するライブラリ</a></li>
    <li><a href="#モデル">モデル</a>
      <ul>
        <li><a href="#todo">Todo</a></li>
      </ul>
    </li>
    <li><a href="#ステートとコントローラ">ステートとコントローラ</a>
      <ul>
        <li><a href="#todosstate">TodosState</a></li>
        <li><a href="#todoscontoller">TodosContoller</a></li>
        <li><a href="#filteredtodosstate">FilteredTodosState</a></li>
        <li><a href="#filteredtodoscontroller">FilteredTodosController</a></li>
        <li><a href="#freezeddartの生成">*.freezed.dartの生成</a></li>
      </ul>
    </li>
    <li><a href="#スクリーン">スクリーン</a>
      <ul>
        <li><a href="#filteredtodos">FilteredTodos</a></li>
        <li><a href="#filteredtodosscreen">FilteredTodosScreen</a></li>
      </ul>
    </li>
    <li><a href="#プロバイダー">プロバイダー</a>
      <ul>
        <li><a href="#maindart">main.dart</a></li>
      </ul>
    </li>
    <li><a href="#実行">実行</a></li>
    <li><a href="#まとめ">まとめ</a></li>
  </ul>
</nav>
      <div class="mt-4 pl-2">
        <h6>Flutterで作ってます</h6>
        <div class="media mt-3">
          <a href="/apps/aozora">
            <div class="appicon rounded mr-2">
              <img src="/apps/aozora/icon.png">
            </div>
          </a>
          <div class="appmedia media-body">
            <a href="/apps/aozora" class="text-dark"><h6 class="mt-0"><strong>Yom!青空文庫</strong></h6></a>
            <a target="_blank" href='https://apps.apple.com/jp/app/yom-%E9%9D%92%E7%A9%BA%E6%96%87%E5%BA%AB/id1530145482'>
              <img width="81px" height="24px" src='/img/badge-lrg.svg'/>
            </a>
            <a target="_blank" href='https://play.google.com/store/apps/details?id=jp.seiichirou.aozora'>
              <img alt='Google Play で手に入れよう' width="81px" height="24px" src='/img/ja_badge_web_generic.png'/>
            </a>
          </div>
        </div>
        <div class="media mt-3">
          <a href="/apps/cube_lbl_memo">
            <div class="appicon rounded mr-2">
              <img src="/apps/cube_lbl_memo/icon.png">
            </div>
          </a>
          <div class="appmedia media-body">
            <a href="/apps/cube_lbl_memo" class="text-dark"><h6 class="mt-0"><strong>CFOPメソッドメモ</strong></h6></a>
            <a target="_blank" href='https://apps.apple.com/jp/app/%E3%83%AB%E3%83%BC%E3%83%93%E3%83%83%E3%82%AF%E3%82%AD%E3%83%A5%E3%83%BC%E3%83%96%E3%81%AE%E8%A7%A3%E6%B3%95-cfop%E3%83%A1%E3%82%BD%E3%83%83%E3%83%89%E3%83%A1%E3%83%A2/id1544644116'>
              <img width="81px" height="24px" src='/img/badge-lrg.svg'/>
            </a>
            <a target="_blank" href='https://play.google.com/store/apps/details?id=jp.seiichirou.cube_lbl_memo'>
              <img alt='Google Play で手に入れよう' width="81px" height="24px" src='/img/ja_badge_web_generic.png'/>
            </a>
          </div>
        </div>
        </div>
    </aside>
  </div>
</article>

    </div>
  </main>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
</body>

</html>