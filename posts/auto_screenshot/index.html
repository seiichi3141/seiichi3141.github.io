<!DOCTYPE html>
<html><head>
  <meta lang="ja">
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="author" content="seiichi3141" />
  <meta name="description" content="プログラミングやFlutter関連の情報" />
  <meta name="keywords" content="プログラミング,Flutter,Dart">
  <title>Riverpodならアプリのスクリーンショットも楽になるかも | 健康優良不良プログラマ</title>
  
  
  <link rel="stylesheet" href="https://blog.seiichirou.jp/sass/main.css" />
  <link href="http://fonts.googleapis.com/earlyaccess/notosansjp.css">
  <link href="https://use.fontawesome.com/releases/v5.9.0/css/all.css" rel="stylesheet">
  <link href="https://blog.seiichirou.jp/css/syntax.css" rel="stylesheet">
  <meta name="google-site-verification" content="hSHRu1AofaNfP4SrnmMHbbG0VYL9D17LOFaRnoUxCjc" />
</head><body><header class="bg-dark">
  <div class="container">
    <nav class="navbar navbar-expand-lg navbar-dark pr-0 pl-0">
      <a class="navbar-brand font-weight-bold" href="/">
        <i class="fas fa-blog text-light d-inline-block align-top lead mr-3"></i>健康優良不良プログラマ
      </a>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav">
          <li class="nav-item dropdown">
            <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
              アプリ
            </a>
            <div class="dropdown-menu" aria-labelledby="navbarDropdown">
              <a class="dropdown-item" href="/apps/aozora">Yom!青空文庫</a>
            </div>
          </li>
        </ul>
      </div>
      <div>
        <a href="https://github.com/seiichi3141"><i class="fab fa-github text-light mr-1"></i></a>
        <a href="https://www.facebook.com/seiichirou.tanaka"><i class="fab fa-facebook text-light mr-1"></i></a>
        <a href="https://twitter.com/seiichi3141"><i class="fab fa-twitter text-light"></i></a>
      </div>
      <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
    </nav>
  </div>
</header><main role="main">
    <div class="container">
<article class="row">
  <div class="pt-5 col-md-9">
    <header>
      <div class="row">
        
        
        <div class="col-12 col-sm-4">
          
          <img class="img-fluid img-thumbnail" src="https://blog.seiichirou.jp/img/flutter_logo.png" alt="">
        </div>
        <div class="col-12 col-sm-8 mt-3 mt-sm-0">
          
          <p class="small mb-1">
            <i class="fas fa-folder mr-1 text-muted"></i>
            
            
            <a class="text-muted" href="https://blog.seiichirou.jp/categories/flutter/">Flutter</a>
            
            
          </p>
          
          <h1 class="font-weight-bold">Riverpodならアプリのスクリーンショットも楽になるかも</h1>
          
          <p class="small mb-1">
            <i class="fas fa-tag text-muted mr-1"></i>
            
            
            <a class="text-muted" href="https://blog.seiichirou.jp/tags/flutter/"><span class="badge badge-secondary align-middle">Flutter</span></a>
            
            
            
            <a class="text-muted" href="https://blog.seiichirou.jp/tags/riverpod/"><span class="badge badge-secondary align-middle">riverpod</span></a>
            
            
            
            <a class="text-muted" href="https://blog.seiichirou.jp/tags/screenshot/"><span class="badge badge-secondary align-middle">screenshot</span></a>
            
            
          </p>
          
        </div>
        
      </div>
    </header>
    <section class="content"><p>次世代のProviderだと何かと話題のRiverpodに手を出しました。すっかり気に入って自作のアプリは全てRiverpodに書き換えてしまいました。</p>
<p>このRiverpodが提供するProviderにはOverrideという機能があります。</p>
<p>この記事ではこのOverrideを使って、手作業でやるには面倒なアプリのスクリーンショットを自動で撮ってみたいと思います。</p>
<h2 id="概要">概要</h2>
<ul>
<li>Flutterアプリのスクリーンショットを自動で撮りたい</li>
<li>Riverpodを使った実装なら好きな状態でスクリーンショットが撮れるかも</li>
</ul>
<h2 id="flutterのバージョン">Flutterのバージョン</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">% flutter --version
Flutter 1.25.0-8.1.pre • channel beta • https://github.com/flutter/flutter.git
Framework • revision 8f89f6505b <span class="o">(</span><span class="m">8</span> days ago<span class="o">)</span> • 2020-12-15 15:07:52 -0800
Engine • revision 92ae191c17
Tools • Dart 2.12.0 <span class="o">(</span>build 2.12.0-133.2.beta<span class="o">)</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="サンプルアプリについて">サンプルアプリについて</h2>
<p>リポジトリは<a href="https://github.com/seiichi3141/take_screenshots.git">ここ</a></p>
<p>メインのソースコードは一本にまとめました。
<a href="https://github.com/seiichi3141/take_screenshots/blob/master/lib/main.dart">https://github.com/seiichi3141/take_screenshots/blob/master/lib/main.dart</a></p>
<ul>
<li>flutter createで作られるサンプルアプリをRiverpod仕様に実装し直して、テーマを変更できるようにしたもの</li>
<li>設定画面を用意する。テーマとダークモードの切替ができるようにする</li>
<li>ホーム画面のAppBarのActionsにIconButtonを追加して設定画面へ遷移できる</li>
</ul>
<p>Web用にビルドしたものが以下です。ダークモード、テーマ色の変更も確認できると思います。</p>
<iframe width="375" height="667" src="https://blog.seiichirou.jp/take_screenshots/"></iframe>
<h3 id="ライブラリ">ライブラリ</h3>
<p>riverpodやflutter_driverを追加しています。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-yaml" data-lang="yaml"><span class="nt">dependencies</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">flutter</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">sdk</span><span class="p">:</span><span class="w"> </span><span class="l">flutter</span><span class="w">
</span><span class="w">  </span><span class="nt">cupertino_icons</span><span class="p">:</span><span class="w"> </span><span class="l">^1.0.0</span><span class="w">
</span><span class="w">  </span><span class="nt">flutter_riverpod</span><span class="p">:</span><span class="w"> </span><span class="l">^0.12.1</span><span class="w">
</span><span class="w">
</span><span class="w"></span><span class="nt">dev_dependencies</span><span class="p">:</span><span class="w">
</span><span class="w">  </span><span class="nt">flutter_test</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">sdk</span><span class="p">:</span><span class="w"> </span><span class="l">flutter</span><span class="w">
</span><span class="w">  </span><span class="nt">flutter_driver</span><span class="p">:</span><span class="w">
</span><span class="w">    </span><span class="nt">sdk</span><span class="p">:</span><span class="w"> </span><span class="l">flutter</span><span class="w">
</span><span class="w">  </span><span class="nt">test</span><span class="p">:</span><span class="w"> </span><span class="l">any</span><span class="w">
</span></code></pre></td></tr></table>
</div>
</div><h3 id="providers">Providers</h3>
<p>Primary Swatch, Brightness, CounterをStateProviderで管理します。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dart" data-lang="dart"><span class="kd">final</span> <span class="n">primarySwatchProvider</span> <span class="o">=</span> <span class="n">StateProvider</span><span class="p">((</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">Colors</span><span class="p">.</span><span class="n">blue</span><span class="p">);</span>
<span class="kd">final</span> <span class="n">brightnessProvider</span> <span class="o">=</span> <span class="n">StateProvider</span><span class="p">((</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">Brightness</span><span class="p">.</span><span class="n">light</span><span class="p">);</span>
<span class="kd">final</span> <span class="n">counterProvider</span> <span class="o">=</span> <span class="n">StateProvider</span><span class="p">((</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="m">0</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="consumer">Consumer</h3>
<p>ConsumerでStateProviderを監視(watch)することでStateに変更があるたびにMaterialAppをRebuildしてくれるようになります。MaterialAppのテーマ変更はアニメーションがおまけでついてきます。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dart" data-lang="dart"><span class="kd">class</span> <span class="nc">MyApp</span> <span class="kd">extends</span> <span class="n">StatelessWidget</span> <span class="p">{</span>
  <span class="err">@</span><span class="n">override</span>
  <span class="n">Widget</span> <span class="n">build</span><span class="p">(</span><span class="n">BuildContext</span> <span class="n">context</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Consumer</span><span class="p">(</span>
      <span class="nl">builder:</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">watch</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">return</span> <span class="n">MaterialApp</span><span class="p">(</span>
          <span class="nl">title:</span> <span class="s1">&#39;Screenshot Demo&#39;</span><span class="p">,</span>
          <span class="nl">debugShowCheckedModeBanner:</span> <span class="kc">false</span><span class="p">,</span>
          <span class="nl">theme:</span> <span class="n">ThemeData</span><span class="p">(</span>
            <span class="nl">primarySwatch:</span> <span class="n">watch</span><span class="p">(</span><span class="n">primarySwatchProvider</span><span class="p">).</span><span class="n">state</span><span class="p">,</span>
            <span class="nl">brightness:</span> <span class="n">watch</span><span class="p">(</span><span class="n">brightnessProvider</span><span class="p">).</span><span class="n">state</span><span class="p">,</span>
          <span class="p">),</span>
          <span class="nl">home:</span> <span class="n">MyHomePage</span><span class="p">(),</span>
        <span class="p">);</span>
      <span class="p">},</span>
    <span class="p">);</span>
  <span class="p">}</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>カウンター表示もこの通りConsumerで囲って監視します。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dart" data-lang="dart"><span class="n">Consumer</span><span class="p">(</span>
  <span class="nl">builder:</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">watch</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">return</span> <span class="n">Text</span><span class="p">(</span>
      <span class="s1">&#39;</span><span class="si">${</span><span class="n">watch</span><span class="p">(</span><span class="n">counterProvider</span><span class="p">).</span><span class="n">state</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">,</span>
      <span class="nl">style:</span> <span class="n">Theme</span><span class="p">.</span><span class="n">of</span><span class="p">(</span><span class="n">context</span><span class="p">).</span><span class="n">textTheme</span><span class="p">.</span><span class="n">headline4</span><span class="p">,</span>
    <span class="p">);</span>
  <span class="p">},</span>
<span class="p">),</span>
</code></pre></td></tr></table>
</div>
</div><h3 id="stateの変更">Stateの変更</h3>
<p>FloatingActionButtonのAddボタンが押された時にcounterProviderのstateを更新します。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dart" data-lang="dart"><span class="nl">floatingActionButton:</span> <span class="n">FloatingActionButton</span><span class="p">(</span>
  <span class="nl">onPressed:</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="n">context</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">counterProvider</span><span class="p">).</span><span class="n">state</span><span class="o">++</span><span class="p">,</span>
  <span class="nl">tooltip:</span> <span class="s1">&#39;Increment&#39;</span><span class="p">,</span>
  <span class="nl">child:</span> <span class="n">Icon</span><span class="p">(</span><span class="n">Icons</span><span class="p">.</span><span class="n">add</span><span class="p">),</span>
<span class="p">),</span>
</code></pre></td></tr></table>
</div>
</div><p>設定画面では例えばSwitchの切り替えでbrightnessProviderのstateを変更します。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dart" data-lang="dart"><span class="k">return</span> <span class="n">SwitchListTile</span><span class="p">(</span>
  <span class="nl">title:</span> <span class="kd">const</span> <span class="n">Text</span><span class="p">(</span><span class="s1">&#39;Dark Mode&#39;</span><span class="p">),</span>
  <span class="nl">value:</span> <span class="n">watch</span><span class="p">(</span><span class="n">brightnessProvider</span><span class="p">).</span><span class="n">state</span> <span class="o">==</span> <span class="n">Brightness</span><span class="p">.</span><span class="n">dark</span><span class="p">,</span>
  <span class="nl">onChanged:</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">value</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">context</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">brightnessProvider</span><span class="p">).</span><span class="n">state</span> <span class="o">=</span> <span class="n">Brightness</span><span class="p">.</span><span class="n">dark</span><span class="p">;</span>
    <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
      <span class="n">context</span><span class="p">.</span><span class="n">read</span><span class="p">(</span><span class="n">brightnessProvider</span><span class="p">).</span><span class="n">state</span> <span class="o">=</span> <span class="n">Brightness</span><span class="p">.</span><span class="n">light</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">},</span>
<span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>今回はこのアプリのスクリーンショットを撮るのを目的とします。</p>
<h2 id="スクリーンショット撮影の流れ">スクリーンショット撮影の流れ</h2>
<p>スクリーンショットの撮影は基本的に以下の流れで行います。</p>
<ul>
<li>スクリーンショット用アプリの起動</li>
<li>テストケース開始</li>
<li>FlutterDriver.requestDataでアプリに変更をリクエスト</li>
<li>スクリーンショット撮影</li>
</ul>
<h2 id="flutter-driver用にアプリを実装する">Flutter Driver用にアプリを実装する</h2>
<p>test_driverディレクトリにスクリーンショット撮影用のアプリapp.dartを実装します。</p>
<p>コードは<a href="https://github.com/seiichi3141/take_screenshots/blob/master/test_driver/app.dart">こちら</a></p>
<p>アプリにはホーム画面と設定画面の二つの画面があります。それを切り替えるために一つProviderを用意します。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dart" data-lang="dart"><span class="n">enum</span> <span class="n">Screen</span> <span class="p">{</span>
  <span class="n">home</span><span class="p">,</span>
  <span class="n">settings</span><span class="p">,</span>
<span class="p">}</span>

<span class="kd">final</span> <span class="n">screenProvider</span> <span class="o">=</span> <span class="n">StateProvider</span><span class="p">((</span><span class="n">_</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="n">Screen</span><span class="p">.</span><span class="n">home</span><span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>撮影用アプリのWidgetツリーに流すProviderを提供するProviderContainerを作っておきます。このContainerのproviderをoverrideすることでツリー配下のWidgetに影響を及ぼすことができるようになります。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dart" data-lang="dart"><span class="kd">final</span> <span class="n">providerContainer</span> <span class="o">=</span> <span class="n">ProviderContainer</span><span class="p">(</span>
  <span class="nl">overrides:</span> <span class="p">[</span>
    <span class="n">screenProvider</span><span class="p">.</span><span class="n">overrideWithValue</span><span class="p">(</span>
      <span class="n">StateController</span><span class="p">(</span><span class="n">Screen</span><span class="p">.</span><span class="n">home</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">primarySwatchProvider</span><span class="p">.</span><span class="n">overrideWithValue</span><span class="p">(</span>
      <span class="n">StateController</span><span class="p">(</span><span class="n">Colors</span><span class="p">.</span><span class="n">blue</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">brightnessProvider</span><span class="p">.</span><span class="n">overrideWithValue</span><span class="p">(</span>
      <span class="n">StateController</span><span class="p">(</span><span class="n">Brightness</span><span class="p">.</span><span class="n">light</span><span class="p">),</span>
    <span class="p">),</span>
    <span class="n">counterProvider</span><span class="p">.</span><span class="n">overrideWithValue</span><span class="p">(</span>
      <span class="n">StateController</span><span class="p">(</span><span class="m">0</span><span class="p">),</span>
    <span class="p">),</span>
  <span class="p">],</span>
<span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>enableFlutterDriverExtension関数を実装します。ここでテストケースからFlutterDriver.requestDataを使って送られてくるデータを処理します。</p>
<p><a href="https://api.flutter.dev/flutter/flutter_driver_extension/enableFlutterDriverExtension.html">enableFlutterDriverExtension</a></p>
<p>以下のコードは抜粋ですが、&lsquo;screen::settings&rsquo;というActionが送られてきたらscreenProviderをScreen.settingsでoverride。&lsquo;brightness::dark&rsquo;というActionが送られてきたらbrightnessProviderをBrightness.darkでoverride、などとスクリーンショットで撮りたい状況に合わせてProviderをoverrideできるようにしておきます。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dart" data-lang="dart">  <span class="n">enableFlutterDriverExtension</span><span class="p">(</span>
    <span class="nl">handler:</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
      <span class="k">switch</span> <span class="p">(</span><span class="n">action</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">case</span> <span class="s1">&#39;screen::settings&#39;</span><span class="o">:</span>
          <span class="n">providerContainer</span><span class="p">.</span><span class="n">updateOverrides</span><span class="p">([</span>
            <span class="n">screenProvider</span><span class="p">.</span><span class="n">overrideWithValue</span><span class="p">(</span>
              <span class="n">StateController</span><span class="p">(</span><span class="n">Screen</span><span class="p">.</span><span class="n">settings</span><span class="p">),</span>
            <span class="p">),</span>
          <span class="p">]);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;brightness::dark&#39;</span><span class="o">:</span>
          <span class="n">providerContainer</span><span class="p">.</span><span class="n">updateOverrides</span><span class="p">([</span>
            <span class="n">brightnessProvider</span><span class="p">.</span><span class="n">overrideWithValue</span><span class="p">(</span>
              <span class="n">StateController</span><span class="p">(</span><span class="n">Brightness</span><span class="p">.</span><span class="n">dark</span><span class="p">),</span>
            <span class="p">),</span>
          <span class="p">]);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;primarySwatch::yellow&#39;</span><span class="o">:</span>
          <span class="n">providerContainer</span><span class="p">.</span><span class="n">updateOverrides</span><span class="p">([</span>
            <span class="n">primarySwatchProvider</span><span class="p">.</span><span class="n">overrideWithValue</span><span class="p">(</span>
              <span class="n">StateController</span><span class="p">(</span><span class="n">Colors</span><span class="p">.</span><span class="n">yellow</span><span class="p">),</span>
            <span class="p">),</span>
          <span class="p">]);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">case</span> <span class="s1">&#39;counter::large&#39;</span><span class="o">:</span>
          <span class="n">providerContainer</span><span class="p">.</span><span class="n">updateOverrides</span><span class="p">([</span>
            <span class="n">counterProvider</span><span class="p">.</span><span class="n">overrideWithValue</span><span class="p">(</span>
              <span class="n">StateController</span><span class="p">(</span><span class="m">99999999</span><span class="p">),</span>
            <span class="p">),</span>
          <span class="p">]);</span>
          <span class="k">break</span><span class="p">;</span>
        <span class="k">default</span><span class="o">:</span>
          <span class="k">break</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">return</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
    <span class="p">},</span>
  <span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>アプリの開始。UncontrolledProviderScopeでproviderContainerをWidgetツリーに流し込みます。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dart" data-lang="dart">  <span class="n">runApp</span><span class="p">(</span>
    <span class="n">UncontrolledProviderScope</span><span class="p">(</span>
      <span class="nl">container:</span> <span class="n">providerContainer</span><span class="p">,</span>
      <span class="nl">child:</span> <span class="n">Consumer</span><span class="p">(</span>
        <span class="nl">builder:</span> <span class="p">(</span><span class="n">context</span><span class="p">,</span> <span class="n">watch</span><span class="p">,</span> <span class="n">_</span><span class="p">)</span> <span class="p">{</span>
          <span class="n">Widget</span> <span class="n">screen</span><span class="p">;</span>
          <span class="k">switch</span> <span class="p">(</span><span class="n">watch</span><span class="p">(</span><span class="n">screenProvider</span><span class="p">).</span><span class="n">state</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">case</span> <span class="n">Screen</span><span class="p">.</span><span class="nl">settings:</span>
              <span class="n">screen</span> <span class="o">=</span> <span class="n">SettingsScreen</span><span class="p">();</span>
              <span class="k">break</span><span class="p">;</span>
            <span class="k">default</span><span class="o">:</span>
              <span class="n">screen</span> <span class="o">=</span> <span class="n">MyHomePage</span><span class="p">();</span>
              <span class="k">break</span><span class="p">;</span>
          <span class="p">}</span>
          <span class="k">return</span> <span class="n">MaterialApp</span><span class="p">(</span>
            <span class="nl">title:</span> <span class="s1">&#39;Screenshot Demo&#39;</span><span class="p">,</span>
            <span class="nl">debugShowCheckedModeBanner:</span> <span class="kc">false</span><span class="p">,</span>
            <span class="nl">theme:</span> <span class="n">ThemeData</span><span class="p">(</span>
              <span class="nl">primarySwatch:</span> <span class="n">watch</span><span class="p">(</span><span class="n">primarySwatchProvider</span><span class="p">).</span><span class="n">state</span><span class="p">,</span>
              <span class="nl">brightness:</span> <span class="n">watch</span><span class="p">(</span><span class="n">brightnessProvider</span><span class="p">).</span><span class="n">state</span><span class="p">,</span>
            <span class="p">),</span>
            <span class="nl">home:</span> <span class="n">screen</span><span class="p">,</span>
          <span class="p">);</span>
        <span class="p">},</span>
      <span class="p">),</span>
    <span class="p">),</span>
  <span class="p">);</span>
</code></pre></td></tr></table>
</div>
</div><p>これでアプリ側は準備完了です。</p>
<h2 id="スクリーンショット撮影ユーティリティ">スクリーンショット撮影ユーティリティ</h2>
<p>コードは<a href="https://github.com/seiichi3141/take_screenshots/blob/master/test_driver/screenshort.dart">こちら</a></p>
<p>FlutterDriverにはスクリーンショット取得をするscreenshot関数が用意されています。アニメーション待ち、ディレクトリ作成、ファイル保存なども行いたいのでユーティリティーとして以下のような関数を用意します。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dart" data-lang="dart"><span class="n">Future</span><span class="o">&lt;</span><span class="kt">void</span><span class="o">&gt;</span> <span class="n">takeScreenshot</span><span class="p">(</span><span class="n">FlutterDriver</span> <span class="n">driver</span><span class="p">,</span> <span class="kt">String</span> <span class="n">path</span><span class="p">)</span> <span class="kd">async</span> <span class="p">{</span>
  <span class="n">print</span><span class="p">(</span><span class="s1">&#39;will take screenshot </span><span class="si">$</span><span class="n">path</span><span class="s1">&#39;</span><span class="p">);</span>
  <span class="kd">await</span> <span class="n">driver</span><span class="p">.</span><span class="n">waitUntilNoTransientCallbacks</span><span class="p">();</span>
  <span class="kd">final</span> <span class="n">pixels</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">driver</span><span class="p">.</span><span class="n">screenshot</span><span class="p">();</span>
  <span class="kd">final</span> <span class="n">dir</span> <span class="o">=</span> <span class="n">Directory</span><span class="p">(</span><span class="s1">&#39;.screenshots&#39;</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">dir</span><span class="p">.</span><span class="n">existsSync</span><span class="p">())</span> <span class="p">{</span>
    <span class="n">dir</span><span class="p">.</span><span class="n">createSync</span><span class="p">();</span>
  <span class="p">}</span>
  <span class="kd">final</span> <span class="n">file</span> <span class="o">=</span> <span class="n">File</span><span class="p">(</span><span class="n">join</span><span class="p">(</span><span class="n">dir</span><span class="p">.</span><span class="n">path</span><span class="p">,</span> <span class="n">path</span><span class="p">));</span>
  <span class="kd">await</span> <span class="n">file</span><span class="p">.</span><span class="n">writeAsBytes</span><span class="p">(</span><span class="n">pixels</span><span class="p">);</span>
  <span class="n">print</span><span class="p">(</span><span class="s1">&#39;wrote </span><span class="si">$</span><span class="n">file</span><span class="s1">&#39;</span><span class="p">);</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="テストケースを実装する">テストケースを実装する</h2>
<p>コードは<a href="https://github.com/seiichi3141/take_screenshots/blob/master/test_driver/app_test.dart">こちら</a></p>
<p>最後にテストケースを実装します。FlutterDriverと接続して、requestDataで撮影したい状況に画面を更新した後にスクリーンショット撮影ユーティリティーでファイル化します。</p>
<p>以下は初期画面を撮影するケースです。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dart" data-lang="dart"><span class="kt">void</span> <span class="n">main</span><span class="p">()</span> <span class="p">{</span>
  <span class="n">group</span><span class="p">(</span><span class="s1">&#39;screenshots&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="p">{</span>
    <span class="n">FlutterDriver</span> <span class="n">driver</span><span class="p">;</span>

    <span class="n">setUpAll</span><span class="p">(()</span> <span class="kd">async</span> <span class="p">{</span>
      <span class="n">driver</span> <span class="o">=</span> <span class="kd">await</span> <span class="n">FlutterDriver</span><span class="p">.</span><span class="n">connect</span><span class="p">();</span>
    <span class="p">});</span>

    <span class="n">tearDownAll</span><span class="p">(()</span> <span class="kd">async</span> <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span><span class="n">driver</span> <span class="o">!=</span> <span class="kc">null</span><span class="p">)</span> <span class="p">{</span>
        <span class="kd">await</span> <span class="n">driver</span><span class="p">.</span><span class="n">close</span><span class="p">();</span>
      <span class="p">}</span>
    <span class="p">});</span>

    <span class="n">test</span><span class="p">(</span><span class="s1">&#39;home light&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
      <span class="kd">await</span> <span class="n">driver</span><span class="p">.</span><span class="n">requestData</span><span class="p">(</span><span class="s1">&#39;brightness::light&#39;</span><span class="p">);</span>
      <span class="kd">await</span> <span class="n">takeScreenshot</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="s1">&#39;home_light.png&#39;</span><span class="p">);</span>
    <span class="p">});</span>
  <span class="p">});</span>
<span class="p">}</span>
</code></pre></td></tr></table>
</div>
</div><p>他にも例えばダークモードで特定のカウンタの状況を写したい場合、設定画面を写したい場合など柔軟に撮影が可能です。</p>
<p>カウンターが99999999の状態を写したい場合など、実際にタップ操作で起こすのが困難なケースでもRiverpodでstateを管理していればすぐに実現可能です。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-dart" data-lang="dart">    <span class="n">test</span><span class="p">(</span><span class="s1">&#39;home dark large counter&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
      <span class="kd">await</span> <span class="n">driver</span><span class="p">.</span><span class="n">requestData</span><span class="p">(</span><span class="s1">&#39;brightness::dark&#39;</span><span class="p">);</span>
      <span class="kd">await</span> <span class="n">driver</span><span class="p">.</span><span class="n">requestData</span><span class="p">(</span><span class="s1">&#39;counter::large&#39;</span><span class="p">);</span>
      <span class="kd">await</span> <span class="n">takeScreenshot</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="s1">&#39;home_dark_large_counter.png&#39;</span><span class="p">);</span>
    <span class="p">});</span>

    <span class="n">test</span><span class="p">(</span><span class="s1">&#39;settings dark&#39;</span><span class="p">,</span> <span class="p">()</span> <span class="kd">async</span> <span class="p">{</span>
      <span class="kd">await</span> <span class="n">driver</span><span class="p">.</span><span class="n">requestData</span><span class="p">(</span><span class="s1">&#39;brightness::dark&#39;</span><span class="p">);</span>
      <span class="kd">await</span> <span class="n">driver</span><span class="p">.</span><span class="n">requestData</span><span class="p">(</span><span class="s1">&#39;screen::settings&#39;</span><span class="p">);</span>
      <span class="kd">await</span> <span class="n">takeScreenshot</span><span class="p">(</span><span class="n">driver</span><span class="p">,</span> <span class="s1">&#39;settings_dark.png&#39;</span><span class="p">);</span>
    <span class="p">});</span>
</code></pre></td></tr></table>
</div>
</div><h2 id="flutter-driverを実行">Flutter Driverを実行</h2>
<p>シミュレータを起動し、以下のコマンドでDriverを実行します。</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre class="chroma"><code class="language-shell" data-lang="shell">% flutter driver --target<span class="o">=</span>test_driver/app.dart
</code></pre></td></tr></table>
</div>
</div><p>以下は撮影をしている様子です。スクリーンが変わっていきます。</p>
<iframe width="214" height="463" src="https://www.youtube.com/embed/3m6JVwjGpZM" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>
<p>指定したディレクトリには撮影した画像が残ります。</p>
<img class="img-fluid rounded" src="/img/take_screenshots.png"/>
<p>以上です。</p>
<h2 id="まとめ">まとめ</h2>
<p>Widgetに与えるデータによって見た目が変わる要素をRiverpodで管理できていればスクリーンショットも撮りやすい。</p>
<p>UIをフレキシブルに変えられるFlutterだからこそ、リリースするアプリのスクリーンショットはいつでも簡単に撮影できるようにしておくとリリース時の手間も大きく減らせると思います。</p>
</section><footer>
  <div class="container mb-5">
    <small>
      <ul class="nav justify-content-center">
        <li class="nav-item"><a class="nav-link text-muted" href="https://twitter.com/seiichi3141">seiichi3141@</a></li>
        
      </ul>
    </small>
  </div>
</footer></div>
  <div class="d-none d-md-block col-md-3 border-left border-right">
    <aside class="toc pt-5">
      <nav id="TableOfContents">
  <ul>
    <li><a href="#概要">概要</a></li>
    <li><a href="#flutterのバージョン">Flutterのバージョン</a></li>
    <li><a href="#サンプルアプリについて">サンプルアプリについて</a>
      <ul>
        <li><a href="#ライブラリ">ライブラリ</a></li>
        <li><a href="#providers">Providers</a></li>
        <li><a href="#consumer">Consumer</a></li>
        <li><a href="#stateの変更">Stateの変更</a></li>
      </ul>
    </li>
    <li><a href="#スクリーンショット撮影の流れ">スクリーンショット撮影の流れ</a></li>
    <li><a href="#flutter-driver用にアプリを実装する">Flutter Driver用にアプリを実装する</a></li>
    <li><a href="#スクリーンショット撮影ユーティリティ">スクリーンショット撮影ユーティリティ</a></li>
    <li><a href="#テストケースを実装する">テストケースを実装する</a></li>
    <li><a href="#flutter-driverを実行">Flutter Driverを実行</a></li>
    <li><a href="#まとめ">まとめ</a></li>
  </ul>
</nav>
    </aside>
  </div>
</article>

    </div>
  </main>
  <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js"
    integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo"
    crossorigin="anonymous"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js"
    integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1"
    crossorigin="anonymous"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js"
    integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM"
    crossorigin="anonymous"></script>
  
  
<script type="application/javascript">
var doNotTrack = false;
if (!doNotTrack) {
	window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
	ga('create', 'UA-145195127-1', 'auto');
	
	ga('send', 'pageview');
}
</script>
<script async src='https://www.google-analytics.com/analytics.js'></script>

  
</body>

</html>